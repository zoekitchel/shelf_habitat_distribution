---
title: "Degree shifts"
output: html_notebook
---

Degree shifts

Second part of paper, if we move away from equator by 1 degree, how much habitat do we gain or lost

I need to look at shelf area by degrees latitude

```{r setup}
library(raster)
library(sf)
library(ncdf4)
library(rmapshaper)
library(tidyverse)
library(diptest)
library(moments)
library(viridis) #colors
library(data.table)
library(hydroTSM) #hypsometric curves
library(gridExtra)
library(maptools)
library(rgdal)
library(rgeos)
library(SpaDES)

etopo_shelf_df <- readRDS("~/Documents/grad school/Rutgers/Repositories/shelf_habitat_distribution/etopo_shelf_df.rds")
#bring in bathy for shelf regions

#LMEs
LME_spdf <- readOGR("LME66/LMEs66.shp")
head(LME_spdf)
```

Make bathy layer into raster
```{r bathy to raster}
proj <- crs(LME_spdf)
etopo_shelf_raster <- rasterFromXYZ(etopo_shelf_df, crs = proj)

```

Crop bathy layer to LMEs (not sure if this is necessary, may just be able to use etopo shelf raster)
```{r}

#crop bathy layer to LME subset
LMEs_extent <- crop(etopo_shelf_raster, extent(LME_spdf))

#which areas of raster fall within borders of LMEs? (Don't know if I have to make LME specific)
#bathy_mask <- mask(LMEs_extent, LME_spdf)

```

Should go by projections of where species are moving:
"Marine organisms have, on average, expanded the leading edges of their distributions by 72.0 ± 13.5 km per decade (generally polewards), while marine phenology in spring has advanced by 4.4 ± 1.1 days decade (Poloczanska et al., 2013)." Poloczanska et al. 2016

72 km is how many degrees?

1° = 111 km

so, 

```{r quick conversion}
72/111*1

```

0.6486˚ is representative of decadal shifts

I will put areas into 0.65 ˚ Bins (180 total degrees, so 180/0.65=276.9231)
--0.33 degree bins conveniently done by raster, so I'll bin in units of two 0.33 degree bins
```{r}
180/0.65
```

Or, should I put area into 0.65*5 = ~3.25˚ bins representative of 50 years? I'll play around with it. 

How does continental shelf habitat change with latitude?

Plot Latitude by Area

Northern Hemisphere

```{r use data table to get bins}
etopo_shelf_dt <- as.data.table(etopo_shelf_df)
etopo_shelf_dt_north <- etopo_shelf_dt[y >= 0,][,habitat := ifelse(is.na(layer), 0,1)]
setorder(etopo_shelf_dt_north, y)
etopo_shelf_dt_south <- etopo_shelf_dt[y <= 0,][,habitat := ifelse(is.na(layer), 0,1)]
setorder(etopo_shelf_dt_south, -y)
```
Binning data
```{r}
etopo_shelf_dt_north_binned <- etopo_shelf_dt_north[,sum(habitat) , .(gr=cut(y,breaks=seq(0,90,by = (2/3))))]
etopo_shelf_dt_south_binned <- etopo_shelf_dt_south[,sum(habitat) , .(gr=cut(y,breaks=seq(0,-90,by = (-2/3))))]
```

Keep above because it's interesting global perspective (how does total shelf area vary by latitude)

However, makes more sense to look at by contiguous coast lines AND we don't actually need depth info TBH!

Eastern Atlantic (3)
-19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 58, 59, 60, 62

Western Atlantic (2)
- 5, 6, 7, 8, 9, 12, 14, 15, 16, 17, 18, 61, 63, 66

Eastern Pacific (1)
- 1, 2, 3, 4, 11, 13, 54, 55, 61, 65

Western Indian (4)
-30, 31, 32, 33

Eastern Indian (5)
-34, 38, 43, 44, 45

Western Pacific (6)
1,	35,	36,	37,	39,	40,	41,	42,	46,	47,	48,	49,	50,	51,	52,	53,	54,	56,	57,	65

Using Hailey's file which seems to line up

Merge LMEs into 6 LMEs

- keep in mind, LME 1 (1&6) and 54 (1&6) and 61 (1&2) and 65 (1&6) appear in multiple
```{r }
west_pac <- c(1,	35,	36,	37,	39,	40,	41,	42,	46,	47,	48,	49,	50,	51,	52,	53,	54,	56,	57,	65)
east_pac <- c(1, 2, 3, 4, 11, 13, 54, 55, 61, 65)
west_atl <- c(5, 6, 7, 8, 9, 12, 14, 15, 16, 17, 18, 61, 63, 66)
east_atl <- c(19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 58, 59, 60, 62)
west_ind <- c(30, 31, 32, 33)
east_ind <- c(34, 38, 43, 44, 45)

#subregions based on LME_number
west_pac_spdf <- LME_spdf[(LME_spdf$LME_NUMBER) %in% west_pac,]
east_pac_spdf <- LME_spdf[(LME_spdf$LME_NUMBER) %in% east_pac,]
west_atl_spdf <- LME_spdf[(LME_spdf$LME_NUMBER) %in% west_atl,]
west_ind_spdf <- LME_spdf[(LME_spdf$LME_NUMBER) %in% west_ind,]
east_atl_spdf <- LME_spdf[(LME_spdf$LME_NUMBER) %in% east_atl,]
east_ind_spdf <- LME_spdf[(LME_spdf$LME_NUMBER) %in% east_ind,]

#for subregions that span 360, we need to change CRS a bit
newCRS <- "+proj=longlat +datum=WGS84 +lon_wrap=180"
west_pac_spdf_shift <- spTransform(west_pac_spdf, CRS(newCRS))
west_pac_spdf_shift <- gBuffer(west_pac_spdf_shift, byid=TRUE, width=0) #gets rid of buffers, allows for union

west_pac_shift_agg <- gUnaryUnion(west_pac_spdf_shift) #dissolve polygons into one

```

Extract bathy data from polygon only to make sure we're limiting to shelf regions above 2000 meters

```{r polygon to raster}
#crop bathy layer to LME subset
west_pac_shift_agg_ext <- crop(etopo_shelf_raster, extent(west_pac_shift_agg))

#which areas of raster fall within borders?
west_pac_shift_agg_mask <- mask(west_pac_shift_agg_ext, west_pac_shift_agg)

```

Spliting raster into many
```{r split raster for regs}
north_extent <- c(xmin(west_pac_shift_agg_mask), xmax(west_pac_shift_agg_mask), 0, ymax(west_pac_shift_agg_mask))
south_extent <- c(xmin(west_pac_shift_agg_mask), xmax(west_pac_shift_agg_mask), ymin(west_pac_shift_agg_mask), 0)

#crop into above and below 0
west_pac_shift_agg_north <- crop(west_pac_shift_agg_mask, extent(north_extent))
west_pac_shift_agg_south <- crop(west_pac_shift_agg_mask, extent(south_extent))

#unfortunately, I think I may have to just do this manually (ugly, I know)

#north chunks for west pacific
west_pac_north_latitudes <- seq(0, ymax(west_pac_shift_agg_mask), by = 0.66)

west_pac_north_shelf_areas <- as.data.table(matrix(nrow = length(west_pac_north_latitudes))) 
west_pac_north_shelf_areas[, latitude_start := as.numeric(V1)][, latitude_end := as.numeric(V1)][, area := as.numeric(V1)][, V1 := NULL]

for (i in 1:(length(west_pac_north_latitudes)-1)) {
  north_extent <- c(xmin(west_pac_shift_agg_mask), xmax(west_pac_shift_agg_mask), west_pac_north_latitudes[i], west_pac_north_latitudes[i+1])
  segment <- crop(west_pac_shift_agg_mask, extent(north_extent))
  
  if(all(is.na(values(segment)))) {
    
  west_pac_north_shelf_areas[i, "latitude_start"] <- west_pac_north_latitudes[i]
  west_pac_north_shelf_areas[i, "latitude_end"] <- west_pac_north_latitudes[i+1]
  west_pac_north_shelf_areas[i, "area"] <- 0
  
  print(i)
    
  } else {
  #get sizes of all cells in raster [km2]
    cell_size<-area(segment, na.rm=TRUE, weights=FALSE)
    #delete NAs from vector of all raster cells
    ##NAs lie outside of the rastered region, can thus be omitted
    cell_size<-cell_size[!is.na(segment)]
    #compute area [km2] of all cells in geo_raster
    segment_area <-length(cell_size)*median(cell_size)

  west_pac_north_shelf_areas[i, "latitude_start"] <- west_pac_north_latitudes[i]
  west_pac_north_shelf_areas[i, "latitude_end"] <- west_pac_north_latitudes[i+1]
  west_pac_north_shelf_areas[i, "area"] <- segment_area
  
  print(i)
  } 
}

for(i in seq_along(df.list)) {
  mod2=try(update(mod,data=df.list[[i]]),TRUE)
  if(isTRUE(class(mod2)=="try-error")) { next } else { mod.list[i]=mod2 } }


#split north raster
ymax(west_pac_shift_agg_north)/0.66

sections <- splitRaster(the_grid, nx=2, ny=2, path="/your_output_path/")
The variable sections is a list of rasters, one for each section of the_grid - access them as:

split_1=sections[[1]]
```


```{r}

#To get a polygon that surrounds cells that are not NA

  # make all values the same.
  r <- reclassify(west_pac_shift_agg_mask, cbind(-Inf, Inf, 1))
  
  # convert to polygons (you need to have package 'rgeos' installed for this to work)
  pp <- rasterToPolygons(r, dissolve=TRUE)
```

Split raster into bins of (2/3) of a degree starting at 0 and going up, and then starting at 0 and going down
```{r}

```


Start trial with West Pac SPDF

Get bins using data table
```{r split south and north}

west_pac_shift_agg.dt_north <- west_pac_shift_agg_dt[y >= 0,]
setorder(west_pac_shift_agg.dt_north, y)
west_pac_shift_agg.dt_south <- west_pac_shift_agg_dt[y <= 0,]
setorder(west_pac_shift_agg.dt_south, -y)
```

Binning data
```{r binning data}
#add new column with 1s
west_pac_shift_agg.dt_north[,habitat := 1]
west_pac_shift_agg.dt_north_binned <- west_pac_shift_agg.dt_north[,sum(habitat), .(gr=cut(y,breaks=seq(0,90,by = (2/3))))]
west_pac_shift_agg.dt_south[,habitat := 1]
west_pac_shift_agg.dt_south_binned <- west_pac_shift_agg.dt_south[,sum(habitat) , .(gr=cut(y,breaks=seq(0,-90,by = (-2/3))))]
```

Preliminary plots
```{r}
west_pac_shift_agg.dt_north_binned[,plot(gr, V1)]
west_pac_shift_agg.dt_south_binned[,plot(gr, V1)]
```

