---
title: "Supplementary Information:\nSensitivity ETOPO1 versus ETOPO2"
author: ZoÃ« Kitchel
date: "`r format(Sys.time(), '%B, %Y')`"
output: pdf_document
---

##Here, we compare using ETOPO2 (2-minute, 1 minute of latitude = 1.853 km at the equator, vertical precision is 1m)
        ##How to deal with: "What about shallow (<200m) water?The satellite altimetry works best in deep    water and can distinguish many undersea features that are not otherwise surveyed directly. In shallow     water, the gravitational effects that can be measured from the satellite are too small to be reliable.    In US waters and some other areas, local high-resolution survey data have been used where available." https://www.ngdc.noaa.gov/mgg/global/etopo2.html#:~:text=It%20covers%20all%20of%20the,one%20kilometer%20at%20the%20equator.
        
##Versus using ETOPO1 (1-minute, 1 minute of latitude = ~1km at the equator, bedrock version, vertical accuracy of ETOPO1 (~10 meters at best)) https://www.ngdc.noaa.gov/mgg/global/


```{r setup, results = 'hide', message = FALSE}
library(raster)
library(sf)
library(ncdf4)
library(rmapshaper)
library(tidyverse)
library(diptest)
library(moments)
library(viridis) #colors
library(data.table)
library(hydroTSM) #hypsometric curves
library(gridExtra)
library(maptools)
library(rgdal)
library(rgeos)
library(SpaDES)
library(rnaturalearth)
library(rnaturalearthdata)
library(equate)
library(here)
library(formatR) #to wrap text for markdown
library(cowplot)

knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE) #wraps text

etopo_shelf_df <- readRDS(file = here::here("raw_data","etopo_shelf_df.rds")) #ETOPO2
etopo1_shelf_df <- readRDS(file = here::here("raw_data","ETOPO1","etopo1_shelf_df.rds")) #ETOPO1
#bring in bathymetry data frame for shelf regions

#LMEs
LME_spdf <- readOGR(here::here("raw_data","LME66","LMEs66.shp")) #spatial points data frame with 
#all 66 LMEs


#convert to equal area projection
  #The Lambert azimuthal equal-area projection is a particular mapping from a 
#sphere to a disk. It accurately represents area in all regions of the sphere, but it does not accurately represent angles.
equalareaprojection <- crs(" +proj=laea ")
```

Convert data frame to raster for bathymetry layer.
```{r bathy to raster, results = 'hide', message=FALSE}

etopo2_shelf_raster <- rasterFromXYZ(etopo_shelf_df, crs = crs(LME_spdf)) #etopo2
etopo1_shelf_raster <- rasterFromXYZ(etopo1_shelf_df, crs = crs(LME_spdf)) #etopo1

```


We will test two regions.

- For degree shifts, I will use East Atlantic Ocean
- For LME depth profiles, I will use High Arctic Canada/Greenland (LME 66)

###Degree Shifts

Eastern Atlantic

LMEs to include
-19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 58, 59, 60, 62

Merge LMEs included in Eastern Atlantic coastline
```{r merge LMEs, results = 'hide', message=FALSE}
east_atl <- c(19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 58, 59, 60, 62)

east_atl_spdf <- LME_spdf[(LME_spdf$LME_NUMBER) %in% east_atl,]

#get rid of buffer for east atl as well to allow for union

east_atl_spdf_nobuf <- gBuffer(east_atl_spdf, byid=TRUE, width=0)

#dissolve polygons into one along coastline
east_atl_spdf_nobuf_agg <- gUnaryUnion(east_atl_spdf_nobuf)
```

Extract bathymetry data from polygon only to make sure we're limiting to shelf regions shallower than 2000 meters

```{r polygon to raster for ETOPO2, results = 'hide', message=FALSE}

#crop bathymetry layer to LME subset (continental shelf habitat in LMEs)
raster_extent_etopo2 <- crop(etopo2_shelf_raster, extent(east_atl_spdf_nobuf_agg))

#which areas of raster fall within borders?
east_atl_spdf_nobuf_agg_mask_etopo2 <- mask(raster_extent_etopo2, east_atl_spdf_nobuf_agg)

#reclassify so that raster only has values of 1, because the only purpose of 
#pulling in bathymetry in this analysis is to limit to shelf areas < 2000m

east_atl_spdf_nobuf_mask_etopo2_1s <- reclassify(east_atl_spdf_nobuf_agg_mask_etopo2, c(-Inf, Inf, 1))
```

```{r polygon to raster for ETOPO1, results = 'hide', message=FALSE}

#crop bathymetry layer to LME subset (continental shelf habitat in LMEs)
raster_extent_etopo1 <- crop(etopo1_shelf_raster, extent(east_atl_spdf_nobuf_agg))

#which areas of raster fall within borders?
east_atl_spdf_nobuf_agg_mask_etopo1 <- mask(raster_extent_etopo1, east_atl_spdf_nobuf_agg)

#reclassify so that raster only has values of 1, because the only purpose of 
#pulling in bathymetry in this analysis is to limit to <2000m

east_atl_spdf_nobuf_mask_etopo1_1s <- reclassify(east_atl_spdf_nobuf_agg_mask_etopo1, c(-Inf, Inf, 1))
```

#####Now, we will split each coastline raster into latitudinal bins of 1 degree 

Eastern Atlantic

*names of raster = east_atl_spdf_nobuf_mask_1s & east_atl_spdf_nobuf_mask_etopo1_1s*

ETOPO2
```{r split raster for eastern atlantic etopo2, results = 'hide', message=FALSE}

#split into northern hemisphere and southern hemisphere
north_extent_etopo2 <- c(xmin(east_atl_spdf_nobuf_mask_etopo2_1s), xmax(east_atl_spdf_nobuf_mask_etopo2_1s), 0, ymax(east_atl_spdf_nobuf_mask_etopo2_1s))
south_extent_etopo2 <- c(xmin(east_atl_spdf_nobuf_mask_etopo2_1s), xmax(east_atl_spdf_nobuf_mask_etopo2_1s), ymin(east_atl_spdf_nobuf_mask_etopo2_1s), 0)

#crop east_atl raster above and below 0
east_atl_spdf_shift_agg_north_etopo2 <- crop(east_atl_spdf_nobuf_mask_etopo2_1s, extent(north_extent_etopo2))

east_atl_spdf_shift_agg_south_etopo2 <- crop(east_atl_spdf_nobuf_mask_etopo2_1s, extent(south_extent_etopo2))

#all 1 degree  latitude sections for east atlantic
east_atl_north_latitudes_etopo2 <- seq(0, ymax(east_atl_spdf_nobuf_mask_etopo2_1s), by = 1)
east_atl_south_latitudes_etopo2 <- seq(0, ymin(east_atl_spdf_nobuf_mask_etopo2_1s), by = -1)

```

ETOPO1
```{r split raster for eastern atlantic etopo1, results = 'hide', message=FALSE}

#split into northern hemisphere and southern hemisphere
north_extent_etopo1 <- c(xmin(east_atl_spdf_nobuf_mask_etopo1_1s), xmax(east_atl_spdf_nobuf_mask_etopo1_1s), 0, ymax(east_atl_spdf_nobuf_mask_etopo1_1s))
south_extent_etopo1 <- c(xmin(east_atl_spdf_nobuf_mask_etopo1_1s), xmax(east_atl_spdf_nobuf_mask_etopo1_1s), ymin(east_atl_spdf_nobuf_mask_etopo1_1s), 0)

#crop east_atl raster above and below 0
east_atl_spdf_shift_agg_north_etopo1 <- crop(east_atl_spdf_nobuf_mask_etopo1_1s, extent(north_extent_etopo1))

east_atl_spdf_shift_agg_south_etopo1 <- crop(east_atl_spdf_nobuf_mask_etopo1_1s, extent(south_extent_etopo1))

#all 1 degree  latitude sections for east atlantic
east_atl_north_latitudes_etopo1 <- seq(0, ymax(east_atl_spdf_nobuf_mask_etopo1_1s), by = 1)
east_atl_south_latitudes_etopo1 <- seq(0, ymin(east_atl_spdf_nobuf_mask_etopo1_1s), by = -1)

```

Now, use loop to populate data table with area values 

```{r populate data table with area values, results = 'hide', message=FALSE}

#setup data table to populate in loop, subtracting because there is one fewer bin than latitude #s
east_atl_shelf_areas <- as.data.table(matrix(nrow = (length(east_atl_north_latitudes_etopo2)-1+length(east_atl_south_latitudes_etopo2)-1))) #same for etopo1 and etopo2
                                      
east_atl_shelf_areas[, latitude_start := as.numeric(V1)][, latitude_end := as.numeric(V1)][, area_rasterarea_etopo2 := as.numeric(V1)][, area_rasterarea_etopo1 := as.numeric(V1)][, V1:= NULL] #I added additional column for etopo1

#loop for north
for (i in 1:(length(east_atl_north_latitudes_etopo2)-1)) {
  #setting up extent for slicing by min and max longitudes, and i to i+1 latitudes
  north_extent_etopo2 <- c(xmin(east_atl_spdf_nobuf_mask_etopo2_1s), xmax(east_atl_spdf_nobuf_mask_etopo2_1s), east_atl_north_latitudes_etopo2[i], east_atl_north_latitudes_etopo2[i+1])
  
  #slightly different because of different resolutions
    north_extent_etopo1 <- c(xmin(east_atl_spdf_nobuf_mask_etopo1_1s),  xmax(east_atl_spdf_nobuf_mask_etopo1_1s), east_atl_north_latitudes_etopo1[i], east_atl_north_latitudes_etopo1[i+1])
  
  #crop raster segement based on bin extent
  segment_north_etopo2 <- crop(east_atl_spdf_nobuf_mask_etopo2_1s, extent(north_extent_etopo2))
  
  segment_north_etopo1 <- crop(east_atl_spdf_nobuf_mask_etopo1_1s, extent(north_extent_etopo1))
  
  
  #populate data table with latitudinal bin (same for both, no need to do twice)
  east_atl_shelf_areas[i, "latitude_start"] <- east_atl_north_latitudes_etopo2[i]
  east_atl_shelf_areas[i, "latitude_end"] <- east_atl_north_latitudes_etopo2[i+1]
  
  #first for etopo2
  if(all(is.na(values(segment_north_etopo2)))) { #if there's no shelf area within a bin, all area = 0
    
  east_atl_shelf_areas[i, "area_rasterarea_etopo2"] <- 0

  
    print(paste0("Etopo2: ",i))
    
  } else { #if there is shelf area within the bin, calculate area of slice
  
    #raster area calculation
      #get sizes of all cells in raster [km2]
    cell_size_raster<-area(segment_north_etopo2, na.rm=TRUE, weights=FALSE)
    
    #delete NAs from vector of all raster cells
    cell_size_raster<-cell_size_raster[!is.na(segment_north_etopo2)]
    
    #sum all values of cell sizes
    segment_area_raster <- sum(cell_size_raster)
    
  #populate data table with raster area
  east_atl_shelf_areas[i, "area_rasterarea_etopo2"] <- segment_area_raster
  
    print(paste0("Etopo2: ",i))
  } 
  
  #then etopo1
    #first for etopo2
  if(all(is.na(values(segment_north_etopo1)))) { #if there's no shelf area within a bin, all area = 0
    
  east_atl_shelf_areas[i, "area_rasterarea_etopo1"] <- 0

  
  print(paste0("Etopo1: ",i))
    
  } else { #if there is shelf area within the bin, calculate area of slice
  
    #raster area calculation
      #get sizes of all cells in raster [km2]
    cell_size_raster<-area(segment_north_etopo1, na.rm=TRUE, weights=FALSE)
    
    #delete NAs from vector of all raster cells
    cell_size_raster<-cell_size_raster[!is.na(segment_north_etopo1)]
    
    #sum all values of cell sizes
    segment_area_raster <- sum(cell_size_raster)
    
  #populate data table with raster area
  east_atl_shelf_areas[i, "area_rasterarea_etopo1"] <- segment_area_raster
  
 
  print(paste0("Etopo1: ",i))
  
  }
}

#loop for south
for (i in 1:(length(east_atl_south_latitudes_etopo2)-1)) {
  #setting up extent for slicing by min and max longitudes, and i to i+1 latitudes
  south_extent_etopo2 <- c(xmin(east_atl_spdf_nobuf_mask_etopo2_1s), xmax(east_atl_spdf_nobuf_mask_etopo2_1s),east_atl_south_latitudes_etopo2[i+1], east_atl_south_latitudes_etopo2[i])
  
  #slightly different because of different resolutions
    south_extent_etopo1 <- c(xmin(east_atl_spdf_nobuf_mask_etopo1_1s),  xmax(east_atl_spdf_nobuf_mask_etopo1_1s), east_atl_south_latitudes_etopo1[i+1], east_atl_south_latitudes_etopo1[i])
  
  #crop raster segment based on bin extent
  segment_south_etopo2 <- crop(east_atl_spdf_nobuf_mask_etopo2_1s, extent(south_extent_etopo2))
  
  segment_south_etopo1 <- crop(east_atl_spdf_nobuf_mask_etopo1_1s, extent(south_extent_etopo1))
  
  
  #populate data table with latitudinal bin (same for both, no need to do twice)
  east_atl_shelf_areas[i+(length(east_atl_north_latitudes_etopo2)-1), "latitude_start"] <- east_atl_south_latitudes_etopo2[i]
  east_atl_shelf_areas[i+(length(east_atl_north_latitudes_etopo2)-1), "latitude_end"] <- east_atl_south_latitudes_etopo2[i+1]
  
  
  #first for etopo2
  if(all(is.na(values(segment_south_etopo2)))) { #if there's no shelf area within a bin, all area = 0
    
  east_atl_shelf_areas[i+(length(east_atl_north_latitudes_etopo2)-1), "area_rasterarea_etopo2"] <- 0

  
    print(paste0("Etopo2: ",i))
    
  } else { #if there is shelf area within the bin, calculate area of slice
  
    #raster area calculation
      #get sizes of all cells in raster [km2]
    cell_size_raster<-area(segment_south_etopo2, na.rm=TRUE, weights=FALSE)
    
    #delete NAs from vector of all raster cells
    cell_size_raster<-cell_size_raster[!is.na(segment_south_etopo2)]
    
    #sum all values of cell sizes
    segment_area_raster <- sum(cell_size_raster)
    
  #populate data table with raster area
  east_atl_shelf_areas[i+(length(east_atl_north_latitudes_etopo2)-1), "area_rasterarea_etopo2"] <- segment_area_raster
  
    print(paste0("Etopo2: ",i))
  } 
  
  #then etopo1

  if(all(is.na(values(segment_south_etopo1)))) { #if there's no shelf area within a bin, all area = 0
    
  east_atl_shelf_areas[i+(length(east_atl_north_latitudes_etopo2)-1), "area_rasterarea_etopo1"] <- 0

  
  print(paste0("Etopo1: ",i))
    
  } else { #if there is shelf area within the bin, calculate area of slice
  
    #raster area calculation
      #get sizes of all cells in raster [km2]
    cell_size_raster<-area(segment_south_etopo1, na.rm=TRUE, weights=FALSE)
    
    #delete NAs from vector of all raster cells
    cell_size_raster<-cell_size_raster[!is.na(segment_south_etopo1)]
    
    #sum all values of cell sizes
    segment_area_raster <- sum(cell_size_raster)
    
  #populate data table with raster area
  east_atl_shelf_areas[i+(length(east_atl_north_latitudes_etopo2)-1), "area_rasterarea_etopo1"] <- segment_area_raster
  
 
  print(paste0("Etopo1: ",i))
  
  }
}

#compare etopo1 versus etopo2
#first, gather for best plotting
east_atl_shelf_areas_long <- melt(east_atl_shelf_areas, id.vars = c("latitude_start", "latitude_end"),
                measure.vars = c("area_rasterarea_etopo2", "area_rasterarea_etopo1"), variable.name = "DEM", value.name = "area")


ggplot(data = east_atl_shelf_areas_long) +
  geom_point(aes(x = latitude_start, y = area, color = DEM)) +
  labs(x = "Latitude", y = "Area km^2") +
  coord_flip() +
  geom_vline(xintercept = 0) +
  theme_classic()

ggsave(filename = "east_atl_shelf_areas_comparison_etopo1_etopo2.pdf", path = here::here("Figures","Supplement"))

cor(east_atl_shelf_areas[,3:4], use = "complete.obs")
```

What's the maximum difference between polygon generated area and raster generated area?
```{r maximum difference, results = F}
east_atl_shelf_areas[, difference := abs(area_rasterarea_etopo2-area_rasterarea_etopo1)]

summary(east_atl_shelf_areas$difference)

ggplot(data = east_atl_shelf_areas, aes(x = difference)) +
  geom_histogram() +
  labs(x = "Difference in km^2") +
  theme_classic()

ggsave(filename = "east_atl_shelf_areas_histogram_etopo1_etopo2.pdf", path = here::here("Figures","Supplement"))
```

###LME Depth Profiles

For LME depth profiles, I will use High Arctic Canada/Greenland (LME = 66)

```{r testing Canadian High Arctic North Greenland prepping shapefile and rasters, results = 'hide', message=FALSE}
 LME_high_arctic <- LME_spdf[LME_spdf@data$LME_NUMBER == 66,]
  
  #clip etopo 2 raster to LME
  LME_high_arctic_extent_etopo2 <- crop(etopo2_shelf_raster, extent(LME_high_arctic))
  
  #clip etopo1 raster to LME
  LME_high_arctic_extent_etopo1 <- crop(etopo1_shelf_raster, extent(LME_high_arctic))
  
  #compare visually
  
  plot(LME_high_arctic_extent_etopo1, main = "ETOPO1")
  plot(LME_high_arctic_extent_etopo2, main = "ETOPO2")
  
```

```{r raster within borders}
  
  #which areas of raster fall within borders?
  LME_high_arctic_mask_etopo2 <- mask(LME_high_arctic_extent_etopo2, LME_high_arctic) #etopo2
  LME_high_arctic_mask_etopo1 <- mask(LME_high_arctic_extent_etopo1, LME_high_arctic) #etopo1
  
  LME_high_arctic_mask_etopo2_1s <- reclassify(LME_high_arctic_mask_etopo2, c(-Inf, Inf, 1)) #this raster is only 1s for etopo2
  
    LME_high_arctic_mask_etopo1_1s <- reclassify(LME_high_arctic_mask_etopo1, c(-Inf, Inf, 1)) #this raster is only 1s for etopo1
  
plot(LME_high_arctic)

#etopo2
plot(LME_high_arctic_mask_etopo2, main = "ETOPO2")
plot(LME_high_arctic_mask_etopo2_1s, main = "ETOPO2")

#etopo1
plot(LME_high_arctic_mask_etopo1, main = "ETOPO1")
plot(LME_high_arctic_mask_etopo1_1s, main = "ETOPO1")
```

#####Next, I need to construct hypsometric plots (how does area available vary by depth). 

Apply `raster::area` directly to list of raster values

```{r calculating cell sizes in Canadian High Arctic North Greenland, results = 'hide', message=FALSE}  


#ETOPO2
 #get sizes of all cells in raster [km2] (vector of size of all cells)
    cell_size_high_arctic_etopo2 <-area(LME_high_arctic_mask_etopo2, na.rm=TRUE, weights=FALSE)
    
        #delete NAs from vector of all raster cells
        cell_size_high_arctic_etopo2<-cell_size_high_arctic_etopo2[!is.na(cell_size_high_arctic_etopo2)]
        
        #ETOPO1
 #get sizes of all cells in raster [km2] (vector of size of all cells)
    cell_size_high_arctic_etopo1 <-area(LME_high_arctic_mask_etopo1, na.rm=TRUE, weights=FALSE)
    
        #delete NAs from vector of all raster cells
        cell_size_high_arctic_etopo1<-cell_size_high_arctic_etopo1[!is.na(cell_size_high_arctic_etopo1)]
  
```

Assign specific sizes to each grid cell
```{r table with cell size versus cell value}

#ETOPO2
#cell_size_high_arctic # cell sizes
#high_arctic_bathy_depth_list # cell values

#bathy depth list

#list of values within raster
  high_arctic_bathy_depth_list_etopo2 <- getValues(LME_high_arctic_mask_etopo2)
  high_arctic_bathy_depth_list_etopo2 <- high_arctic_bathy_depth_list_etopo2[!is.na(high_arctic_bathy_depth_list_etopo2)] #get rid of NA's

cell_size_cell_value_etopo2 <- data.table(cell_size = cell_size_high_arctic_etopo2, depth = high_arctic_bathy_depth_list_etopo2)

cor(cell_size_cell_value_etopo2$depth, cell_size_cell_value_etopo2$cell_size) #Not super correlated (0.09480613)
plot(-cell_size_cell_value_etopo2$depth, cell_size_cell_value_etopo2$cell_size, pch = ".", main = "ETOPO2") 

##ETOPO1
#cell_size_high_arctic # cell sizes
#high_arctic_bathy_depth_list # cell values

#bathy depth list

#list of values within raster
  high_arctic_bathy_depth_list_etopo1 <- getValues(LME_high_arctic_mask_etopo1)
  high_arctic_bathy_depth_list_etopo1 <- high_arctic_bathy_depth_list_etopo1[!is.na(high_arctic_bathy_depth_list_etopo1)] #get rid of NA's

cell_size_cell_value_etopo1 <- data.table(cell_size = cell_size_high_arctic_etopo1, depth = high_arctic_bathy_depth_list_etopo1)

cor(cell_size_cell_value_etopo1$depth, cell_size_cell_value_etopo1$cell_size) #Not super correlated (0.09480613)
plot(-cell_size_cell_value_etopo1$depth, cell_size_cell_value_etopo1$cell_size, pch = ".", main = "ETOPO1") 

#difference in resolution between etopo1 and 2 is clear by looking at cell size
```

Sum area across cells with same depth
```{r sum area across cells with same depth, results = 'hide', message=FALSE}
#######ETOPO2
cell_size_cell_value_etopo2[,sum_area := sum(cell_size), by = depth]

#reduce to frequency table
freq_table_raster_etopo2 <- unique(cell_size_cell_value_etopo2, by = c("depth", "sum_area"))

freq_table_raster_etopo2[,cell_size := NULL] #remove cell size column
freq_table_raster_etopo2[,depth := -depth] #make depth positive

#plot this frequency table
raster_areabycell_plot_etopo2 <- ggplot(
  data = freq_table_raster_etopo2, aes(x = depth,y = sum_area,fill = depth)) +
    geom_col(width = 5) +
    theme_classic() +
    labs(x = "Depth (m)", y = expression(paste("Area (", km^{2},")")),
         fill = "Depth (m)") +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(0,0)) +
    scale_fill_gradientn(colors = rev(viridis(5)), limits = c(0, 2000)) +
    guides(position = "bottom", fill = guide_colorbar(reverse = T))

########ETOPO1

cell_size_cell_value_etopo1[,sum_area := sum(cell_size), by = depth]

#reduce to frequency table
freq_table_raster_etopo1 <- unique(cell_size_cell_value_etopo1, by = c("depth", "sum_area"))

freq_table_raster_etopo1[,cell_size := NULL] #remove cell size column
freq_table_raster_etopo1[,depth := -depth] #make depth positive

#plot this frequency table
raster_areabycell_plot_etopo1 <- ggplot(
  data = freq_table_raster_etopo1, aes(x = depth,y = sum_area,fill = depth)) +
    geom_col(width = 5) +
    theme_classic() +
    labs(x = "Depth (m)", y = expression(paste("Area (", km^{2},")")),
         fill = "Depth (m)") +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(0,0)) +
    scale_fill_gradientn(colors = rev(viridis(5)), limits = c(0, 2000)) +
    guides(position = "bottom", fill = guide_colorbar(reverse = T))

raster_areabycell_plot_etopo2
raster_areabycell_plot_etopo1

```



Let's compare the two graphs visually
```{r graphic comparison}
plot_grid(raster_areabycell_plot_etopo2 + theme(legend.position = "none"), raster_areabycell_plot_etopo1 + theme(legend.position = "none"), labels = c("ETOPO2","ETOPO1"), ncol = 2, label_x = 0.5)

#similar shape, higher values for ETOPO1
```

Visually, the shape does not change a ton

But, what about the statistics, and final classification?

For raster taking into consideration bias correction. The output is a frequency table, therefore, in order to calculate modality, we need to generate a vector of values from the frequency table. 

For skew etc., we can use the equate package in r to apply calculations directly to frequency table.

```{r generate vector of values for modality calculation with diptest package, results = 'hide', message=FALSE}

####ETOPO2
freq_table_raster_etopo2[,prop_area :=  sum_area/sum(sum_area)] #calculate proportional area

freq_table_raster_etopo2[,area_rounddown := round(prop_area * 10000000, 0)]

#empty vector
LME_high_arctic_data_vector_etopo2 <- vector()

#populate vector
for (i in 1:nrow(freq_table_raster_etopo2)){
add <- rep(freq_table_raster_etopo2[i,depth], freq_table_raster_etopo2[i,area_rounddown])
LME_high_arctic_data_vector_etopo2 <- append(LME_high_arctic_data_vector_etopo2, add,
                                      after = length(LME_high_arctic_data_vector_etopo2))

}


####ETOPO1
freq_table_raster_etopo1[,prop_area :=  sum_area/sum(sum_area)] #calculate proportional area

freq_table_raster_etopo1[,area_rounddown := round(prop_area * 10000000, 0)]

#empty vector
LME_high_arctic_data_vector_etopo1 <- vector()

#populate vector
for (i in 1:nrow(freq_table_raster_etopo1)){
add <- rep(freq_table_raster_etopo1[i,depth], freq_table_raster_etopo1[i,area_rounddown])
LME_high_arctic_data_vector_etopo1 <- append(LME_high_arctic_data_vector_etopo1, add,
                                      after = length(LME_high_arctic_data_vector_etopo1))

}

#plotting
hist(LME_high_arctic_data_vector_etopo2, 1000, main = "ETOPO2")
hist(LME_high_arctic_data_vector_etopo1, 1000, main = "ETOPO1")
```
Note that especially most shallow areas are under represented by ETOPO2

Perform calculations on etopo1 and etopo2 raster. This takes time

```{r calculations on etopo2 versus etopo1 raster depth frequency table, results = 'hide', message=FALSE}
#ETOPO2
freq_table_etopo2_raster.ft <- as.freqtab(freq_table_raster_etopo2[,1:2])

dip.test_etopo2_raster <- dip.test(LME_high_arctic_data_vector_etopo2, simulate.p.value = TRUE, B = 2000)
#this takes a while, probably more than 30 minutes
  p.value_dip.test_etopo2_raster <- dip.test_etopo2_raster$p.value
  skew_dip.test_etopo2_raster <- skew.freqtab(freq_table_etopo2_raster.ft)
  mean_etopo2_raster <- mean(freq_table_etopo2_raster.ft)
  max_depth_etopo2_raster <- max(freq_table_etopo2_raster.ft)
  median_depth_etopo2_raster <- median(freq_table_etopo2_raster.ft)
  
  
saveRDS(dip.test_etopo2_raster, file = here::here("output","etopo2_etopo1_comparison","dip.test_etopo2_raster.rds"))

#ETOPO1
freq_table_etopo1_raster.ft <- as.freqtab(freq_table_raster_etopo1[,1:2])

dip.test_etopo1_raster <- dip.test(LME_high_arctic_data_vector_etopo1, simulate.p.value = TRUE, B = 2000)
#this takes a while, probably more than 30 minutes
  p.value_dip.test_etopo1_raster <- dip.test_etopo1_raster$p.value
  skew_dip.test_etopo1_raster <- skew.freqtab(freq_table_etopo1_raster.ft)
  mean_etopo1_raster <- mean(freq_table_etopo1_raster.ft)
  max_depth_etopo1_raster <- max(freq_table_etopo1_raster.ft)
  median_depth_etopo1_raster <- median(freq_table_etopo1_raster.ft)
  
  
saveRDS(dip.test_etopo1_raster, file = here::here("output","etopo2_etopo1_comparison","dip.test_etopo1_raster.rds"))

```

Re-plot both methods with all the statistics, and classification based on:

Multimodal: diptest value > 0.01, p-value <0.05; else
Mid-Dominant: -1 < skew value < 1
Shallow Dominant: skew value > 1
Deep Dominant: skew value < -1


```{r final plot comparison}

#plot for etopo2 raster
raster_etopo2 <- raster_areabycell_plot +
annotate("text", x = 600, y = 1650, label = "LME 66: Canadian High Arctic: ETOPO2 Raster") +
  annotate("text", x = 700, y = 1550, label = paste0("Dip Test: ", signif(dip.test_etopo2_raster$statistic,2), " P-value = ", signif(p.value_dip.test_etopo2_raster, 2))) +
  annotate("text", x = 700, y = 1450, label = paste0("Skew: ", round(skew_dip.test_etopo2_raster,2))) +
  annotate("text", x = 700, y = 1350, label = paste0("Mean: ",round(mean_etopo2_raster,2), " m")) +
  annotate("text", x = 700, y = 1250, label = "Classification = Mid-Dominant") + #check
  geom_vline(xintercept = mean_etopo2_raster, color = "red")

#plot for etopo1 raster
raster_etopo1 <- raster_areabycell_plot +
annotate("text", x = 600, y = 1650, label = "LME 66: Canadian High Arctic: etopo1 Raster") +
  annotate("text", x = 700, y = 1550, label = paste0("Dip Test: ", signif(dip.test_etopo1_raster$statistic,2), " P-value = ", signif(p.value_dip.test_etopo1_raster, 2))) +
  annotate("text", x = 700, y = 1450, label = paste0("Skew: ", round(skew_dip.test_etopo1_raster,2))) +
  annotate("text", x = 700, y = 1350, label = paste0("Mean: ",round(mean_etopo1_raster,2), " m")) +
  annotate("text", x = 700, y = 1250, label = "Classification = Mid-Dominant") + #check
  geom_vline(xintercept = mean_etopo1_raster, color = "red")

comparison <- plot_grid(raster_etopo2 + theme(legend.position = "none"), raster_etopo1 + theme(legend.position = "none"), rows = 1, cols = 2)

comparison_w_legend <- plot_grid(comparison, get_legend(raster_etopo2), cols = 2, rows = 1, rel_widths = c(8,1))

ggsave(comparison_w_legend, filename = "depth_etopo1_etopo2_comparison.pdf", path = here::here("Figures","Supplement"), width = 12, height = 4, units = "in")

```

Note if there is a change in classification between the two methods.
